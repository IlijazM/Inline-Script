const $d = document
const body = $d.body
const head = $d.head
const $q = (v) => $d.querySelector(v)
const $q_ = (v) => $d.querySelector("." + inlineScriptUidPrefix + v)
const $qa = (v) => $d.querySelectorAll(v)
const append = (str) => body.innerHTML += str

function $e(htmlString) {
    let div = document.createElement('div');
    div.style.display = "none"
    div.innerHTML = htmlString.trim();
    return div.firstChild;
}

const console_log = console.log
const console_error = console.error
const console_group = console.group
const console_groupEnd = console.groupEnd
const console_group_ = (g, f) => { console_group(g); f(); console_groupEnd(g) }

const importRegex = /include\s*\(/gm
const importRegexAlt = /import\s\s*(["'`])(?:(?=(\\?))\2.)*?\1/gm
const stringRegex = /(["'`])(?:(?=(\\?))\2.)*?\1/gm

const htmlStartRegex = /\(\s*</m
const htmlEndRegex = />\s*\)/gm

const doubleBracketsRegex = /\{\{(.*?)\}\}/gm

// const htmlStartScript = "eval(`" + inlinescript + "inlinescript(COMMAND_COMPILE,{element:$e(\\`<"
// const htmlEndScript = ">\\`)}).outerHTML`)"

// const htmlStartScript = "this.innerHTML=`"
// const htmlEndScript = "`;eval(`" + inlinescript + "setTimeout(()=>{inlinescript(COMMAND_COMPILE_CHILDS,{element:this}).innerHTML})`);this.innerHTML"

const htmlStartScript = "eval(`" + "this.innerHTML = \\`"
const htmlEndScript = "\\`;\n\n" + inlinescript + "\n\nsetTimeout(()=>{inlinescript(COMMAND_COMPILE_CHILDS,{element:this})});this.innerHTML`)"

function reverseSanitation(html) {
    const replaceList = {
        '&gt;': '>',
        '&lt;': '<',
    }
    Object.keys(replaceList).forEach((i) => {
        html = html.split(i).join(replaceList[i])
    })

    return html
}

const inlineScriptUidPrefix = "inline-script-uid-"
let inlineScriptId = 0
function generateUniqueId() { return inlineScriptId++ }

const COMMAND_COMPILE = 0
const COMMAND_INCLUDE = 1
const COMMAND_COMPILE_CHILDS = 2

const badQuote = "`"

function inlinescript(n,m){function t(a,b,c){var d=new XMLHttpRequest;d.onload=function(){void 0===c?b.innerHTML=d.responseText:c(b,d.responseText);b.querySelectorAll("script").forEach(function(e){var f=document.createElement("script");f.innerHTML=e.innerHTML;body.appendChild(f)});scopeStyles(b);inlinescript(COMMAND_COMPILE_CHILDS,{element:b})};d.open("GET",a,!0);d.send(null)}function u(a){try{return eval("let _="+a+";_"),a}catch(b){return"'"+a+"'"}}function v(a){if(null!=a.attributes.getNamedItem("include")){var b=
    a.attributes.getNamedItem("include").value,c="";Array.from(a.attributes).filter(function(d){return!["reacts-to","id","class","include"].includes(d.name)}).forEach(function(d){var e=u(d.value);c+="let "+d.name+"="+e+";"});t(b,a,function(d,e){d.innerHTML="<div>{"+c+"(<div>"+e+"</div>)}</div>"})}}function w(a){a.includes(badQuote)&&(console.log("html: "+a),console.error("An inline script may not contain a '"+badQuote+"' symbol."));for(var b=0,c="",d=0;d<a.length;d++){var e=a.substr(d,1),f=a.substr(d,
    2);if("(<"===f){if(b++,1===b){c+=htmlStartScript;continue}}else if(">)"===f&&(b--,0===b)){c+=">";c+=htmlEndScript;d++;continue}c+=e}return c}function x(a){if(null!=a.attributes.getNamedItem("reacts-to")){var b=a.attributes.getNamedItem("reacts-to").value;void 0==k[b]&&(k[b]=[]);k[b].push(a.uniqueId)}}function y(a){try{if(a.hasInlinescript=!1,void 0===a.inlinescript){var b=a.innerHTML;b=reverseSanitation(b);a.render=function(){this.compileAttributes()};if(b.trim().startsWith("{"))if(a.hasInlinescript=
    !0,b=w(b),a.inlinescript=b,a.render=function(){var d=this;this.compileAttributes();if("BUTTON"==a.tagName){var e="SUBMIT";try{e=a.attributes.getNamedItem("value").value}catch(g){}a.innerHTML=e}try{var f=eval(this.inlinescript)}catch(g){console_group_("An error occured while evaluating the script from element:",function(){console_log(d);console_log("script:");console_log(d.inlinescript);console_error(g)})}f instanceof Array&&(f=f.join(""));if("BUTTON"!==this.tagName)this.innerHTML=f;else{this.compileAttributes();
    e="SUBMIT";try{e=a.attributes.getNamedItem("value").value}catch(g){}a.innerHTML=e}},"BUTTON"==a.tagName){b="SUBMIT";try{b=a.attributes.getNamedItem("value").value}catch(d){}a.innerHTML=b;var c="."+inlineScriptUidPrefix+a.uniqueId;$q(c).setAttribute("onclick","$q('"+c+"').render()")}else a.render()}}catch(d){console_group_("An error occured while compiling the content of the element:",function(){console_log(a);console_error(d)})}}function z(a){a.initialAttributes=[];Array.from(a.attributes).forEach(function(b){a.initialAttributes[b.name]=
    b.value});a.compileAttributes=function(){var b=this,c=Object.entries(a.initialAttributes);doubleBracketsRegex.lastIndex=0;c.forEach(function(d){for(var e=[],f=d[1],g;null!==(g=doubleBracketsRegex.exec(f));)g.index===doubleBracketsRegex.lastIndex&&doubleBracketsRegex.lastIndex++,g.forEach(function(l,h){0===h&&(e.includes(l)||e.push(l))});e.forEach(function(l){try{var h=eval(l);"string"!==typeof h&&(h=JSON.stringify(h))}catch(A){h="undefined"}b.setAttribute(d[0],f.split(l).join(h))})})};a.compileAttributes()}
    function p(a){Array.from(a.children).forEach(function(b){q(b)})}function q(a){try{var b=generateUniqueId();a.uniqueId=b;a.classList.add(inlineScriptUidPrefix+b);z(a);v(a);y(a);a.hasInlinescript?x(a):p(a)}catch(c){console_group_("An error occured while compiling the element:",function(){console_log(a);console_error(c)})}return a}var k={},r=[];setInterval(function(){var a={},b;for(b in k){a.$jscomp$loop$prop$reactiveElement$3=k[b];var c=eval(b);if(r[b]!==c)for(r[b]=c,c={$jscomp$loop$prop$i$6:0};c.$jscomp$loop$prop$i$6<
    a.$jscomp$loop$prop$reactiveElement$3.length;c={$jscomp$loop$prop$i$6:c.$jscomp$loop$prop$i$6},c.$jscomp$loop$prop$i$6++)try{document.querySelector("."+inlineScriptUidPrefix+a.$jscomp$loop$prop$reactiveElement$3[c.$jscomp$loop$prop$i$6]).render()}catch(d){console_group_("removed element",function(e,f){return function(){console_log("."+inlineScriptUidPrefix+e.$jscomp$loop$prop$reactiveElement$3[f.$jscomp$loop$prop$i$6])}}(a,c)),k[b]=a.$jscomp$loop$prop$reactiveElement$3.filter(function(e){return function(f,
    g){return g!==e.$jscomp$loop$prop$i$6}}(c))}a={$jscomp$loop$prop$reactiveElement$3:a.$jscomp$loop$prop$reactiveElement$3}}},50);if(void 0!=n){if(n===COMMAND_COMPILE)return q(m.element),m.element;if(n===COMMAND_COMPILE_CHILDS)return p(m.element),m.element}};

inlinescript(COMMAND_COMPILE, { element: body })
